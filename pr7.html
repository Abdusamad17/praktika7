<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PR7 — WebAR</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: radial-gradient(1200px 700px at 50% 20%, #1a1033 0%, #070814 55%, #05060a 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #fff;
    }

    a-scene { position: fixed; inset: 0; }

    .header {
      position: fixed;
      top: 14px;
      left: 14px;
      right: 14px;
      z-index: 10;
      pointer-events: none;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .pill {
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      font-size: 13px;
      white-space: nowrap;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #b7b7b7;
      box-shadow: 0 0 0 3px rgba(183,183,183,0.18);
    }

    .dot.ok {
      background: #44ff99;
      box-shadow: 0 0 0 3px rgba(68,255,153,0.18);
    }

    .footer {
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: 14px;
      z-index: 10;
      pointer-events: none;
      display: grid;
      gap: 10px;
    }

    .card {
      pointer-events: auto;
      border-radius: 18px;
      padding: 14px;
      background: rgba(0,0,0,0.46);
      border: 1px solid rgba(255,255,255,0.16);
      backdrop-filter: blur(12px);
    }

    .title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .text {
      font-size: 12px;
      opacity: .92;
      line-height: 1.35;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      pointer-events: auto;
      cursor: pointer;
      border: 0;
      border-radius: 14px;
      padding: 12px;
      font-size: 15px;
      font-weight: 700;
      flex: 1 1 auto;
      background: #fff;
      color: #0b1020;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="pill">
      <span id="dot" class="dot"></span>
      <span id="status">Готово к запуску</span>
    </div>
    <div class="pill">PR7 • WebAR</div>
  </div>

  <div class="footer">
    <div class="card">
      <div class="title">Наведение на маркер</div>
      <div class="text">
        Нажмите «Запустить AR» и наведите камеру на picture.<br>
        1 палец — перемещение • 2 пальца — масштаб и вращение
      </div>
      <div class="actions">
        <button id="startBtn">Запустить AR</button>
      </div>
    </div>
  </div>

  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: picture.mind; autoStart: false; uiScanning: false; uiLoading: false;"
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
  >
    <a-assets>
      <a-asset-item id="model" src="obj.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity light="type: ambient; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 1.2" position="0.2 1.4 1"></a-entity>

    <a-entity id="markerRoot" mindar-image-target="targetIndex: 0">
      <a-entity
        id="obj"
        gltf-model="#model"
        position="0 0.08 0"
        rotation="0 180 0"
        scale="1 1 1"
      ></a-entity>

      <a-ring
        position="0 0 0"
        rotation="-90 0 0"
        radius-inner="0.18"
        radius-outer="0.36"
        material="opacity: 0; transparent: true"
      ></a-ring>
    </a-entity>
  </a-scene>

  <script>
    const sceneEl = document.getElementById("scene");
    const markerRoot = document.getElementById("markerRoot");
    const obj = document.getElementById("obj");
    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");
    const dotEl = document.getElementById("dot");

    startBtn.addEventListener("click", async () => {
      statusEl.textContent = "Запуск камеры…";
      startBtn.disabled = true;
      if (!sceneEl.hasLoaded) {
        await new Promise(r => sceneEl.addEventListener("loaded", r, { once: true }));
      }
      sceneEl.systems["mindar-image-system"].start();
      statusEl.textContent = "Камера запущена";
    });

    markerRoot.addEventListener("targetFound", () => {
      statusEl.textContent = "Маркер распознан";
      dotEl.classList.add("ok");
    });

    markerRoot.addEventListener("targetLost", () => {
      statusEl.textContent = "Ищу маркер…";
      dotEl.classList.remove("ok");
    });

    let mode = "none";
    let lastX = 0, lastY = 0;
    let startDist = 0;
    let startScale = 1;
    let startAngle = 0;
    let startRotY = 0;

    const MOVE_FACTOR = 0.0015;

    function dist(a, b) {
      return Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
    }

    function angle(a, b) {
      return Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX) * 180 / Math.PI;
    }

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    document.addEventListener("touchstart", e => {
      if (e.touches.length === 1) {
        mode = "drag";
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }
      if (e.touches.length === 2) {
        mode = "pinch";
        startDist = dist(e.touches[0], e.touches[1]);
        startScale = obj.object3D.scale.x;
        startAngle = angle(e.touches[0], e.touches[1]);
        startRotY = obj.object3D.rotation.y * 180 / Math.PI;
      }
    }, { passive: true });

    document.addEventListener("touchmove", e => {
      if (mode === "drag" && e.touches.length === 1) {
        const dx = e.touches[0].clientX - lastX;
        const dy = e.touches[0].clientY - lastY;
        obj.object3D.position.x += dx * MOVE_FACTOR;
        obj.object3D.position.z += dy * MOVE_FACTOR;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }
      if (mode === "pinch" && e.touches.length === 2) {
        const d = dist(e.touches[0], e.touches[1]);
        const s = clamp(startScale * (d / startDist), 0.12, 2.5);
        obj.object3D.scale.set(s, s, s);
        const a = angle(e.touches[0], e.touches[1]);
        obj.object3D.rotation.y = (startRotY + (a - startAngle)) * Math.PI / 180;
      }
    }, { passive: true });

    document.addEventListener("touchend", e => {
      if (e.touches.length === 0) mode = "none";
    }, { passive: true });
  </script>

</body>
</html>
